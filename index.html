<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GameHub - Accueil (Public/Supabase)</title>
<style>
  /* ... (Vos styles CSS restent les m√™mes) ... */
  body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#0f1724; color:#fff; text-align:center; }
  .wrap{max-width:900px;margin:28px auto;padding:20px;}
  .card{background:#111;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6); margin-bottom:18px;}
  input{padding:10px 12px;border-radius:8px;border:1px solid #333;width:70%;max-width:320px}
  button, .menu-link{padding:10px 16px;border-radius:8px;border:0;background:#ff8c00;color:#08101a;font-weight:700;cursor:pointer;text-decoration:none;display:block;text-align:center;}
  button.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
  .small{color:#9aa0a6;font-size:14px}
  ol{text-align:left;margin:8px auto;padding-left:18px;max-width:400px}
  .error{color:#ffb3a7;margin-top:10px}
  .actions{margin-top:12px;display:flex;gap:8px;justify-content:center}
  .game-score{font-weight:normal;color:rgba(8, 16, 26, 0.7);margin-left:8px;}
  .shop-btn { background:#00aaff; color:white; font-weight:700; }
  .intranet-btn { background:#1e90ff; color:white; font-weight:700; } 
</style>

<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config.js"></script> 
    
    </head>

</head>
<body>
  <div class="wrap">
    <h1>üéÆ GameHub</h1>

    <div id="loginCard" class="card">
      <h2>Connexion</h2>
      <div>
        <input id="playerName" placeholder="Tape ton pseudo puis Entr√©e" autocomplete="off" />
      </div>
      <div class="actions">
        <button id="enterBtn">Entrer</button>
        <button id="clearBtn" class="ghost">Effacer donn√©es locales</button>
      </div>
      <div id="loginError" class="error" style="display:none;"></div>
      <p class="small">Le pseudo est n√©cessaire pour le classement en ligne.</p>
    </div>

    <div id="menuCard" class="card" style="display:none;">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center">
        <div id="avatar" style="width:64px;height:64px;border-radius:50%;background:#ff8c00;display:flex;align-items:center;justify-content:center;font-weight:800;color:#08101a;font-size:30px"></div>
        <div>
          <div id="welcome" style="font-size:18px;font-weight:700"></div>
          <div class="small">Connect√©</div>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;flex-direction:column;gap:8px;align-items:center">
        <button id="btnJeu1" onclick="go('jeu1.html')">Jeu 1 ‚Äî R√©action</button>
        <button id="btnJeu2" onclick="go('jeu2.html')">Jeu 2 ‚Äî √âvitement</button>
        <button id="btnJeu3" onclick="go('jeu3.html')">Jeu 3 ‚Äî M√©moire</button>
        <button id="btnJeu4" onclick="go('jeu4.html')">Jeu 4 ‚Äî Snake</button>
        <button id="btnJeu5" onclick="go('jeu5.html')">Jeu 5 ‚Äî Flappy</button>
        <button id="btnJeu6" onclick="go('jeu6.html')">Jeu 6 ‚Äî Pong</button>
        <button id="btnJeu7" onclick="go('jeu7.html')">Jeu 7 ‚Äî Puzzle Taquin</button>
        <button id="btnJeu8" onclick="go('jeu8.html')">Jeu 8 ‚Äî Clicker</button>
        
        <div style="margin-top:15px; display:flex; gap: 8px;">
            <button class="menu-link shop-btn" onclick="go('boutique.html')">üõí Boutique</button>
            <a href="http://10.100.200.1" target="_blank" class="menu-link intranet-btn">üåê Intranet</a>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="ghost" onclick="logout()">D√©connexion</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üèÜ Classement Mondial</h2>
      <div id="leaderboardContainer">
        <p class="small">Chargement des scores en cours...</p>
        </div>
      <p class="small">Top 3 de chaque jeu (Base de donn√©es en ligne)</p>
    </div>
  </div>

<script>
/* --- MAP des noms de jeu --- */
const GAME_MAP = {
    'jeu1.html': 'Jeu 1 ‚Äî R√©action',
    'jeu2.html': 'Jeu 2 ‚Äî √âvitement',
    'jeu3.html': 'Jeu 3 ‚Äî M√©moire',
    'jeu4.html': 'Jeu 4 ‚Äî Snake',
    'jeu5.html': 'Jeu 5 ‚Äî Flappy',
    'jeu6.html': 'Jeu 6 ‚Äî Pong',
    'jeu7.html': 'Jeu 7 ‚Äî Puzzle Taquin',
    'jeu8.html': 'Jeu 8 ‚Äî Clicker',
    'boutique.html': 'Achat (Bonus)' 
};

/* --------- Utilitaires --------- */

function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    let color = '#';
    for (let i = 0; i < 3; i++) {
        let value = (hash >> (i * 8)) & 0xFF;
        color += ('00' + value.toString(16)).substr(-2);
    }
    return color;
}

/* --------- Login / Menu --------- */
const input = document.getElementById('playerName');
const enterBtn = document.getElementById('enterBtn');
const clearBtn = document.getElementById('clearBtn');
const loginError = document.getElementById('loginError');

enterBtn.addEventListener('click', login);
input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') login(); });

clearBtn.addEventListener('click', ()=>{
  if(confirm('Effacer le pseudo et tous les scores locaux (si existants) ?')) {
    localStorage.removeItem('gh_player'); 
    localStorage.removeItem('gh_avatar');
    // NOTE: On ne touche pas aux scores locaux car la sauvegarde en ligne est prioritaire
    location.reload();
  }
});

function login(){
  const name = input.value.trim();
  if(!name){
    loginError.style.display='block';
    loginError.innerText = 'Le pseudo est vide ‚Äî entre un pseudo valide.';
    return;
  }
  loginError.style.display='none';
  localStorage.setItem('gh_player', name);
  localStorage.setItem('gh_avatar', name[0].toUpperCase());
  
  showMenu(name);
  loadScores();
}

function logout(){
  localStorage.removeItem('gh_player'); 
  localStorage.removeItem('gh_avatar');
  document.getElementById('menuCard').style.display='none';
  document.getElementById('loginCard').style.display='block';
  input.value='';
}

/* --------- Affichage du Menu --------- */
function showMenu(name){
  document.getElementById('loginCard').style.display='none';
  document.getElementById('menuCard').style.display='block';
  document.getElementById('welcome').innerText = 'Bienvenue, ' + name;
  
  const avatarElement = document.getElementById('avatar');
  const avatarChar = (localStorage.getItem('gh_avatar') || name[0].toUpperCase());
  
  avatarElement.innerText = avatarChar;
  avatarElement.style.background = stringToColor(name);

  // NOTE: Les scores personnels pourraient √™tre charg√©s ici, mais nous simplifions en nous concentrant sur le classement mondial
}

document.addEventListener('DOMContentLoaded', ()=>{
  const stored = localStorage.getItem('gh_player');
  if(stored){
    input.value = stored;
    showMenu(stored);
  }
  loadScores();
});


/* --------- Leaderboard MONDIAUX (NOUVEAU) --------- */
async function loadScores(){
  const container = document.getElementById('leaderboardContainer');
  container.innerHTML = '<p class="small">Connexion √† la base de donn√©es...</p>';

  // 1. R√©cup√©rer tous les scores depuis la table Supabase 'scores'
  const { data: allScores, error } = await supabaseClient
    .from('scores')
    .select('player_name, game_name, score, moves')
    .limit(2000); 

  if (error) {
    console.error("Erreur de chargement des scores:", error);
    container.innerHTML = '<p class="error">Impossible de charger le classement. V√©rifiez la connexion Supabase ou le RLS.</p>';
    return;
  }

  // 2. Traitement C√¥t√© Client: Filtrer et garder le meilleur score par joueur/jeu
  const bestScoresByGame = {};
  for (const scoreEntry of allScores) {
    const game = scoreEntry.game_name;
    const playerName = scoreEntry.player_name;

    if (!bestScoresByGame[game]) bestScoresByGame[game] = {};
    const currentBest = bestScoresByGame[game][playerName];

    const isTaquin = game.includes('Puzzle Taquin');
    
    let isBetter;
    
    // Logique de tri: MAX pour la plupart des jeux, MIN pour le Taquin (coups/temps)
    if (isTaquin) {
        // Taquin: Moins de temps (score) est mieux
        isBetter = !currentBest || scoreEntry.score < currentBest.score;
    } else {
        // Autres: Plus de points est mieux
        isBetter = !currentBest || scoreEntry.score > currentBest.score;
    }

    if (isBetter) {
      bestScoresByGame[game][playerName] = scoreEntry;
    }
  }

  // 3. Affichage du Classement
  container.innerHTML = '';
  const playerName = localStorage.getItem('gh_player');
  const gameNames = Object.values(GAME_MAP);
  
  // Afficher les jeux dans l'ordre du MAP
  for (const game of gameNames) {
    const scoresForGame = Object.values(bestScoresByGame[game] || {});
    
    if (scoresForGame.length === 0) continue;

    // Trier les scores pour le Top 3
    if (game.includes('Puzzle Taquin')) {
        scoresForGame.sort((a, b) => a.score - b.score); // MIN score (temps)
    } else {
        scoresForGame.sort((a, b) => b.score - a.score); // MAX score (points)
    }

    // Cr√©ation de l'affichage
    const gameTitle = document.createElement('h3');
    gameTitle.textContent = game;
    gameTitle.style.marginTop = '20px';
    container.appendChild(gameTitle);

    const ol = document.createElement('ol');
    ol.style.maxWidth = '400px';
    ol.style.margin = '8px auto';
    container.appendChild(ol);

    // Afficher le Top 3
    scoresForGame.slice(0, 3).forEach(s => {
      const li = document.createElement('li');
      
      let scoreText = s.score.toLocaleString('fr-FR');
      
      // Formatage sp√©cifique pour le Taquin et le Clicker
      if (game.includes('Puzzle Taquin')) {
          const minutes = Math.floor(s.score / 60);
          const seconds = s.score % 60;
          scoreText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} (Coups: ${s.moves || '?'})`;
      } else if (game.includes('Clicker') || game.includes('Achat')) {
          scoreText = `${s.score.toLocaleString('fr-FR')} ressources`;
      }
      
      li.textContent = `${s.player_name} ‚Äî ${scoreText}`;
      
      if (s.player_name === playerName) {
        li.style.fontWeight = 'bold';
        li.style.color = '#00ff66';
      }
      ol.appendChild(li);
    });
  }
  
  if (container.innerHTML === '') {
      container.innerHTML = '<p class="small">Aucun score en ligne pour l\'instant. Jouez le premier !</p>';
  }
}

/* --------- Navigation helper --------- */
function go(page){
  if(!localStorage.getItem('gh_player')){
    alert('Tu dois te connecter avant de lancer un jeu.');
    return;
  }
  location.href = page;
}
</script>
</body>
</html>

