<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeu 7 - Puzzle Taquin Ultime</title>
<style>
body { background:#0f1724; color:white; font-family:Arial; text-align:center; }
button { padding:10px 20px; margin:10px; border-radius:8px; border:0; cursor:pointer; font-weight:bold; }
#start { background:#00ff66; }
#back { background:#ff8c00; }
#gameArea { 
    background:#111; 
    margin:20px auto; 
    position:relative; 
    border-radius:10px; 
    display: grid;
    gap: 5px;
    padding: 5px;
}
.tile {
    background: #00aaff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #08101a;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s, background 0.1s;
    user-select: none;
    font-size: 1.5em; 
}
.empty {
    background: transparent;
    cursor: default;
}
.tile:active {
    transform: scale(0.95);
}
#instructions {
    max-width: 600px;
    margin: 10px auto;
    padding: 15px;
    background: #0d141e;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
    color: #9aa0a6;
}
#instructions strong { color: white; }
#message { color: #00ff66; font-weight: bold; margin-bottom: 15px; }
#timerDisplay {
    font-size: 1.2em;
    font-weight: bold;
    color: #ff8c00;
}
#previewContainer {
    width: 100px;
    height: 100px;
    background: #333;
    margin: 0 auto 10px;
    border-radius: 5px;
    line-height: 100px;
    font-size: 12px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase_config.js"></script>
<script src="online_functions.js"></script>
</head>
<body>

<h1>Jeu 7 ‚Äî Puzzle Taquin Ultime</h1>

<button id="back" onclick="location.href='index.html'">Retour</button>

<div id="instructions">
    <h3>Mode d'emploi :</h3>
    <ul>
        <li><strong>Objectif :</strong> R√©ordonner les tuiles (1, 2, 3...) jusqu'√† la case vide finale (0).</li>
        <li><strong>Jouer :</strong> Cliquez sur une tuile adjacente √† la case vide.</li>
        <li><strong>Score :</strong> Le classement est bas√© sur le **temps** et le nombre de **coups**.</li>
    </ul>
</div>

<div id="difficultySelector">
    <button onclick="selectDifficulty(3)">Grille 3x3 (Facile)</button>
    <button onclick="selectDifficulty(4)">Grille 4x4 (Moyen)</button>
    <button onclick="selectDifficulty(5)">Grille 5x5 (Difficile)</button>
</div>

<div id="message">S√©lectionnez la taille de la grille pour d√©marrer.</div>

<div id="statsDisplay" style="display:none;">
    <h2>Coups : <span id="score">0</span></h2>
    <div id="timerDisplay">Temps : 0:00</div>
</div>

<div id="previewContainer">Solution : 1, 2, 3...</div>

<div id="gameArea">
  </div>

<script>
// --- Variables d'√âtat ---
let tiles = []; 
let score = 0;  // Nombre de coups
let timer = 0; // Temps en secondes
let timerInterval;
let active = false;
let GRID_SIZE = 3; 
const TILE_COUNT = () => GRID_SIZE * GRID_SIZE; 
const GAME_NAME = "Jeu 7 ‚Äî Puzzle Taquin";

// --- DOM Elements ---
const gameArea = document.getElementById("gameArea");
const scoreDisplay = document.getElementById("score");
const messageDisplay = document.getElementById("message");
const timerDisplay = document.getElementById("timerDisplay");
const difficultySelector = document.getElementById("difficultySelector");
const previewContainer = document.getElementById("previewContainer");
const statsDisplay = document.getElementById("statsDisplay");

// --- Fonctions de D√©marrage et Contr√¥le ---

function selectDifficulty(size) {
    GRID_SIZE = size;
    messageDisplay.textContent = `Grille ${size}x${size} s√©lectionn√©e. Cliquez sur D√©marrer.`;
    
    // Configurer la grille et afficher l'aper√ßu
    const tileSize = 300 / GRID_SIZE;
    gameArea.style.width = '300px'; 
    gameArea.style.height = '300px';
    gameArea.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 1fr)`;
    gameArea.style.gridTemplateRows = `repeat(${GRID_SIZE}, 1fr)`;

    previewContainer.textContent = `Solution: 1 √† ${TILE_COUNT() - 1}, puis vide`;
    
    createTiles();
    statsDisplay.style.display = 'block';
    document.getElementById("start").onclick = startGame; 
}

function startGame() {
    if (active) return;
    
    active = true;
    score = 0;
    timer = 0;
    scoreDisplay.textContent = 0;
    
    shuffleTiles();
    render();
    
    messageDisplay.textContent = "C'est parti !";
    startTimer();
}

function gameOver() {
    active = false;
    stopTimer();
    
    messageDisplay.textContent = `Bravo ! R√©solu en ${formatTime(timer)} et ${score} coups.`;
    
    // üì¢ SAUVEGARDE EN LIGNE
    // Le score est le temps en secondes, les coups sont pass√©s en param√®tre 'moves'
    saveScore(timer, `${GAME_NAME} (${GRID_SIZE}x${GRID_SIZE})`, score); 
    
    alert(`F√©licitations ! Puzzle r√©solu en ${formatTime(timer)} et ${score} coups.`);
}

// --- Logique du Chronom√®tre ---

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timer++;
        timerDisplay.textContent = `Temps : ${formatTime(timer)}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

// --- Logique de la Grille ---

function createTiles() {
    gameArea.innerHTML = '';
    const total = TILE_COUNT();
    for (let i = 0; i < total; i++) {
        const d = document.createElement("div");
        d.classList.add("tile");
        d.dataset.index = i;
        d.onclick = () => moveTile(i);
        gameArea.appendChild(d);
    }
}

/**
 * M√©lange les tuiles et garantit la solvabilit√© du puzzle (version simplifi√©e).
 */
function shuffleTiles() {
    const total = TILE_COUNT();
    tiles = Array.from({length: total}, (_, i) => i + 1);
    tiles[total - 1] = 0;

    let inversions;
    let solvable = false;
    
    while (!solvable) {
        // M√©lange (Fisher-Yates)
        for (let i = total - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
        }
        
        inversions = 0;
        const flatTiles = tiles.filter(t => t !== 0); 
        
        for (let i = 0; i < flatTiles.length; i++) {
            for (let j = i + 1; j < flatTiles.length; j++) {
                if (flatTiles[i] > flatTiles[j]) {
                    inversions++;
                }
            }
        }
        
        // Puzzle r√©solvable si le nombre d'inversions est pair (pour les grilles impaires)
        solvable = (inversions % 2 === 0);
        
        if (inversions === 0 && total > 2) {
             solvable = false;
        }
    }
}

// Met √† jour l'affichage des tuiles
function render() {
    const tileElements = gameArea.children;
    for (let i = 0; i < TILE_COUNT(); i++) {
        const val = tiles[i];
        const d = tileElements[i];
        
        d.dataset.value = val;
        d.textContent = val === 0 ? '' : val;
        
        if (val === 0) {
            d.classList.add('empty');
        } else {
            d.classList.remove('empty');
        }
    }
}

// Tente de d√©placer une tuile
function moveTile(index) {
    if (!active) return;

    const emptyIndex = tiles.indexOf(0);
    
    const row = Math.floor(index / GRID_SIZE);
    const col = index % GRID_SIZE;
    const emptyRow = Math.floor(emptyIndex / GRID_SIZE);
    const emptyCol = emptyIndex % GRID_SIZE;

    const isAdjacent = Math.abs(row - emptyRow) + Math.abs(col - emptyCol) === 1;

    if (isAdjacent) {
        
        const tileToMove = gameArea.children[index];
        const emptyTile = gameArea.children[emptyIndex];
        
        // √âchange des classes et des valeurs dans le DOM
        tileToMove.style.order = emptyIndex;
        emptyTile.style.order = index;

        // Mise √† jour du tableau interne
        [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
        
        score++;
        scoreDisplay.textContent = score;
        
        render(); 
        
        if (checkWin()) {
            gameOver();
        }
    }
}

// V√©rifie si les tuiles sont dans l'ordre (1, 2, 3, ..., N*N - 1, 0)
function checkWin() {
    const total = TILE_COUNT();
    for (let i = 0; i < total - 1; i++) {
        if (tiles[i] !== i + 1) {
            return false;
        }
    }
    return tiles[total - 1] === 0;
}


// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
    // Cr√©e la grille 3x3 par d√©faut au chargement
    selectDifficulty(3);
});
</script>
</body>
</html>
